# KDT Dashboard 마이그레이션 가이드

## 개요
이 문서는 기존 클라이언트 사이드 계산 로직을 백엔드 API로 전환하는 마이그레이션 가이드입니다.

---

## 마이그레이션 목표

1. **성능 개선**: 브라우저에서 수행하던 무거운 계산을 서버로 이동
2. **일관성 확보**: 프론트엔드와 백엔드의 계산 로직 통일
3. **유지보수성 향상**: 계산 로직을 한 곳에서 관리
4. **확장성**: 향후 다른 클라이언트(모바일 앱 등)에서도 동일한 API 사용 가능

---

## 마이그레이션 단계

### 1단계: 백엔드 API 준비 (우선 완료 필요)

- [ ] 모든 통계 계산 API 구현
- [ ] 골든 테스트 케이스 통과 확인
- [ ] 데이터 정합성 리포트 구현
- [ ] API 문서 작성

### 2단계: 프론트엔드 API 클라이언트 생성

#### 2.1 새 API 클라이언트 파일 생성

**파일**: `kdt-dashboard-new/src/lib/api-client.ts`

```typescript
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

export interface InstitutionStatsResponse {
  status: string;
  data: InstitutionStat[];
  pagination?: {
    total: number;
    page: number;
    page_size: number;
    total_pages: number;
  };
}

export interface YearlyStatsResponse {
  status: string;
  data: YearlyStat;
}

export interface MonthlyStatsResponse {
  status: string;
  data: MonthlyStat[];
  year?: number;
  summary?: {
    total_revenue: number;
    total_students: number;
    total_completed: number;
    avg_completion_rate: number;
    avg_employment_rate: number;
  };
}

export interface HealthCheckResponse {
  row_count: number;
  valid_rows: number;
  invalid_rows: number;
  revenue_zero_count: number;
  date_format_errors: number;
  missing_required_fields: number;
  institution_grouping_applied: number;
  leading_company_courses: number;
  revenue_adjustment_applied: number;
  three_week_rule_excluded: number;
  year_range: {
    start: number;
    end: number;
  };
  institution_count: number;
  course_count: number;
  total_revenue: number;
  warnings: Array<{
    type: string;
    count: number;
    description: string;
  }>;
  errors: Array<{
    row: number;
    field: string;
    issue: string;
    value: any;
  }>;
}

export class KDTStatsAPI {
  private baseUrl: string;

  constructor(baseUrl: string = API_BASE_URL) {
    this.baseUrl = baseUrl;
  }

  /**
   * 기관별 통계 조회
   */
  async getInstitutionStats(
    year?: number,
    revenueMode: 'current' | 'max' = 'current'
  ): Promise<InstitutionStatsResponse> {
    const params = new URLSearchParams();
    if (year) params.append('year', year.toString());
    if (revenueMode) params.append('revenue_mode', revenueMode);

    const response = await fetch(
      `${this.baseUrl}/api/v1/institution-stats?${params}`,
      {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }

    return response.json();
  }

  /**
   * 연도별 통계 조회
   */
  async getYearlyStats(year?: number): Promise<YearlyStatsResponse> {
    const params = new URLSearchParams();
    if (year) params.append('year', year.toString());

    const response = await fetch(
      `${this.baseUrl}/api/v1/yearly-stats?${params}`,
      {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }

    return response.json();
  }

  /**
   * 월별 통계 조회
   */
  async getMonthlyStats(year?: number): Promise<MonthlyStatsResponse> {
    const params = new URLSearchParams();
    if (year) params.append('year', year.toString());

    const response = await fetch(
      `${this.baseUrl}/api/v1/monthly-stats?${params}`,
      {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }

    return response.json();
  }

  /**
   * CSV 파일 업로드
   */
  async uploadCSV(file: File): Promise<{
    status: string;
    message: string;
    data: {
      processed_courses: number;
      processing_time_ms: number;
      institution_count: number;
      year_range: {
        start: number;
        end: number;
      };
    };
    health_check: HealthCheckResponse;
  }> {
    const formData = new FormData();
    formData.append('csv_file', file);

    const response = await fetch(`${this.baseUrl}/api/v1/upload-csv`, {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }

    return response.json();
  }

  /**
   * 골든 테스트 케이스 검증
   */
  async validateGoldenCases(): Promise<{
    status: string;
    test_results: Array<{
      test_case_id: string;
      passed: boolean;
      expected: any;
      actual: any;
      differences: Array<{
        field: string;
        expected: any;
        actual: any;
        difference: number;
      }>;
    }>;
    summary: {
      total: number;
      passed: number;
      failed: number;
      pass_rate: number;
    };
  }> {
    const response = await fetch(`${this.baseUrl}/api/v1/test/golden-cases`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.statusText}`);
    }

    return response.json();
  }
}

// 싱글톤 인스턴스 export
export const kdtAPI = new KDTStatsAPI();
```

### 3단계: 기존 코드 주석 처리 및 새 API 적용

#### 3.1 InstitutionAnalysisClient.tsx 수정

**Before:**
```typescript
// ❌ 기존 코드
import { calculateInstitutionStats, aggregateCoursesByCourseIdWithLatestInfo } from "@/lib/data-utils";

const stats = calculateInstitutionStats(processedData, selectedYear);
const aggregated = aggregateCoursesByCourseIdWithLatestInfo(courses, selectedYear);
const completionRate = (totalCompleted / totalStudents) * 100;
```

**After:**
```typescript
// ✅ 새 코드
import { kdtAPI } from "@/lib/api-client";

const [stats, setStats] = useState<InstitutionStat[]>([]);
const [loading, setLoading] = useState(true);

useEffect(() => {
  const fetchStats = async () => {
    try {
      setLoading(true);
      const response = await kdtAPI.getInstitutionStats(selectedYear);
      setStats(response.data);
    } catch (error) {
      console.error('Failed to fetch institution stats:', error);
    } finally {
      setLoading(false);
    }
  };

  fetchStats();
}, [selectedYear]);

// API에서 이미 계산된 display 필드 사용
const completionRate = stats[0]?.completion_rate; // 이미 계산된 값
const completionRateDetail = stats[0]?.completion_rate_detail; // "90.0% (180/200)"
```

#### 3.2 monthly-analysis/page.tsx 수정

**Before:**
```typescript
// ❌ 기존 코드
import { calculateMonthlyStatistics, computeCourseRevenue } from "@/lib/data-utils";

const monthlyStats = calculateMonthlyStatistics(processedData, selectedYear);
const courseRevenue = computeCourseRevenue(course, year);
```

**After:**
```typescript
// ✅ 새 코드
import { kdtAPI } from "@/lib/api-client";

const [monthlyStats, setMonthlyStats] = useState<MonthlyStat[]>([]);

useEffect(() => {
  const fetchMonthlyStats = async () => {
    try {
      const response = await kdtAPI.getMonthlyStats(selectedYear);
      setMonthlyStats(response.data);
    } catch (error) {
      console.error('Failed to fetch monthly stats:', error);
    }
  };

  fetchMonthlyStats();
}, [selectedYear]);

// API 응답에서 이미 계산된 값 사용
const courseRevenue = course.총누적매출; // API에서 계산된 값
```

#### 3.3 yearly-analysis/page.tsx 수정

**Before:**
```typescript
// ❌ 기존 코드
const stats = generateYearlyStats(processedData);
```

**After:**
```typescript
// ✅ 새 코드
import { kdtAPI } from "@/lib/api-client";

const [yearlyStats, setYearlyStats] = useState<YearlyStat | null>(null);

useEffect(() => {
  const fetchYearlyStats = async () => {
    try {
      const response = await kdtAPI.getYearlyStats(selectedYear);
      setYearlyStats(response.data);
    } catch (error) {
      console.error('Failed to fetch yearly stats:', error);
    }
  };

  fetchYearlyStats();
}, [selectedYear]);
```

### 4단계: 사용하지 않는 코드 제거

#### 4.1 data-utils.ts에서 제거할 함수들

다음 함수들은 **완전히 삭제**하거나 백엔드로 이동:

- `calculateInstitutionStats` - 삭제
- `computeCourseRevenue` - 삭제
- `calculateCompletionRate` - 삭제
- `calculateMonthlyStatistics` - 삭제
- `aggregateCoursesByCourseIdWithLatestInfo` - 삭제
- `calculateInstitutionDetailedRevenue` - 삭제
- `getPreferredEmploymentCount` - 삭제 (백엔드로 이동)
- `calculateRevenueAdjustmentFactor` - 삭제 (백엔드로 이동)
- `groupInstitutionsAdvanced` - 삭제 (백엔드로 이동)
- `transformRawDataToCourseData` - 삭제 (백엔드로 이동)
- `transformRawDataArray` - 삭제 (백엔드로 이동)

**유지할 함수들** (프론트엔드에서도 사용):
- `parseNumber` - 유틸리티 함수로 유지 가능
- `parsePercentage` - 유틸리티 함수로 유지 가능
- `parseDate` - 유틸리티 함수로 유지 가능
- 타입 정의들 (`CourseData`, `InstitutionStat` 등) - 유지

### 5단계: 테스트 및 검증

#### 5.1 골든 테스트 케이스 검증

```typescript
// 개발 환경에서 골든 테스트 케이스 실행
const testResults = await kdtAPI.validateGoldenCases();
console.log('Golden Test Results:', testResults);

if (testResults.summary.failed > 0) {
  console.error('Some golden test cases failed!');
  testResults.test_results.forEach(result => {
    if (!result.passed) {
      console.error(`Failed: ${result.test_case_id}`, result.differences);
    }
  });
}
```

#### 5.2 기존 결과와 새 결과 비교

```typescript
// 마이그레이션 전후 결과 비교 스크립트
const oldResult = calculateInstitutionStats(oldData, 2024);
const newResult = await kdtAPI.getInstitutionStats(2024);

// 비교 로직
const compareResults = (old: any, new: any) => {
  // 각 필드 비교
  // 차이가 있으면 경고 출력
};
```

---

## 롤백 계획

마이그레이션 중 문제가 발생하면:

1. **환경 변수로 전환 가능하도록 구현**
   ```typescript
   const USE_NEW_API = process.env.NEXT_PUBLIC_USE_NEW_API === 'true';
   
   if (USE_NEW_API) {
     // 새 API 사용
     const stats = await kdtAPI.getInstitutionStats(year);
   } else {
     // 기존 로직 사용 (주석 처리된 코드)
     const stats = calculateInstitutionStats(data, year);
   }
   ```

2. **기존 코드는 주석 처리만 하고 삭제하지 않음**
   - 최소 1개월간 유지
   - 문제 발생 시 즉시 롤백 가능

3. **문제 발생 시 즉시 구 API로 롤백**
   - 환경 변수 변경만으로 전환
   - 배포 없이 즉시 적용

---

## 체크리스트

### 백엔드 작업
- [ ] 모든 통계 계산 API 구현 완료
- [ ] 골든 테스트 케이스 통과 확인
- [ ] 데이터 정합성 리포트 구현
- [ ] API 문서 작성
- [ ] 성능 테스트 완료

### 프론트엔드 작업
- [ ] API 클라이언트 생성 (`src/lib/api-client.ts`)
- [ ] `InstitutionAnalysisClient.tsx` 수정
- [ ] `monthly-analysis/page.tsx` 수정
- [ ] `yearly-analysis/page.tsx` 수정
- [ ] `employment-analysis/page.tsx` 수정
- [ ] 사용하지 않는 import 제거
- [ ] `data-utils.ts`의 계산 함수들 삭제

### 테스트
- [ ] 골든 테스트 케이스 검증
- [ ] 기존 결과와 새 결과 비교
- [ ] 성능 테스트 (기존 vs 새)
- [ ] 사용자 시나리오 테스트

### 배포
- [ ] 스테이징 환경 배포
- [ ] 스테이징 환경 테스트
- [ ] 프로덕션 환경 배포
- [ ] 모니터링 설정

---

## 주의사항

1. **점진적 마이그레이션**: 한 번에 모든 페이지를 변경하지 말고, 하나씩 마이그레이션
2. **백업**: 기존 코드는 주석 처리만 하고 최소 1개월간 유지
3. **테스트**: 각 페이지 마이그레이션 후 즉시 테스트
4. **문서화**: 변경 사항을 명확히 문서화
5. **커뮤니케이션**: 팀원들과 변경 사항 공유

---

**문서 버전**: 1.0  
**최종 수정일**: 2025-01-XX  
**작성자**: 개발팀
