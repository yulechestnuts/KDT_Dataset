# KDT Dashboard 통계 수식 정리 문서

이 문서는 kdt-dashboard-new 프로젝트에서 CSV 파일을 파싱하여 사용하는 모든 통계 계산식들을 정리한 것입니다.

## 목차
1. [기본 데이터 파싱](#기본-데이터-파싱)
2. [수료율 계산](#수료율-계산)
3. [매출 관련 계산](#매출-관련-계산)
4. [취업 관련 계산](#취업-관련-계산)
5. [기관별 통계 계산](#기관별-통계-계산)
6. [월별 통계 계산](#월별-통계-계산)
7. [연도별 통계 계산](#연도별-통계-계산)
8. [과정 집계 계산](#과정-집계-계산)
9. [만족도 계산](#만족도-계산)

---

## 기본 데이터 파싱

### 1. 숫자 파싱 (`parseNumber`)
```typescript
// CSV에서 읽은 값을 숫자로 변환
// - null, undefined, 빈 문자열 → 0
// - 쉼표, 공백, %, 원 제거 후 파싱
// - '-' 또는 'N/A' → 0
```

### 2. 퍼센트 파싱 (`parsePercentage`)
```typescript
// 퍼센트 문자열을 숫자로 변환
// 예: "88.1%" → 88.1
// - % 기호와 공백 제거 후 파싱
```

### 3. 괄호 포함 숫자 파싱 (`parseNumberWithParen`)
```typescript
// "x(y)" 형식의 숫자 파싱
// 예: "100(50)" → { value: 100, display: "100(50)", paren: 50 }
// - x: 현재 연도 값
// - y: 과거 연도 값
```

### 4. 누적 매출 계산
```typescript
// 연도별 매출 합산
누적매출 = Σ(2021년 + 2022년 + 2023년 + 2024년 + 2025년 + 2026년)
```

### 5. 총 훈련 시간 계산
```typescript
// 총훈련시간이 없으면 총훈련일수 × 8시간으로 계산
총훈련시간 = 총훈련일수 × 8
```

---

## 수료율 계산

### 1. 기본 수료율 계산 (`calculateCompletionRate`)
```typescript
// 필터링 조건:
// 1. 해당 연도에 종료된 과정만 (year 파라미터가 있는 경우)
// 2. 수료인원 > 0
// 3. 수강신청 인원 > 0
// 4. 과정 종료일이 오늘 기준 3주 이상 지난 과정만 포함

수료율(%) = (전체 수료인원 합계 / 전체 수강신청 인원 합계) × 100
```

**제외 조건:**
- 수료인원이 0인 과정
- 수강신청 인원이 0인 과정
- 과정 종료일이 오늘 기준 21일 이내인 과정

### 2. 과정별 수료율
```typescript
과정별_수료율(%) = (해당 과정의 수료인원 / 해당 과정의 수강신청 인원) × 100
```

---

## 매출 관련 계산

### 1. 매출 조정 계수 (`calculateRevenueAdjustmentFactor`)
```typescript
// 수료율에 따른 매출 보정 계수
if (수료율 >= 100%) {
    계수 = 1.25  // 100% 이상일 때 1.25배
} else if (수료율 >= 75%) {
    계수 = 1.0 + (0.25 × (수료율 - 75) / 25)  // 75~100%: 선형 증가 (1.0 → 1.25)
} else if (수료율 >= 50%) {
    계수 = 0.75 + (0.25 × (수료율 - 50) / 25)  // 50~75%: 선형 증가 (0.75 → 1.0)
} else {
    계수 = 0.75  // 50% 미만: 0.75배
}
```

**예시:**
- 수료율 100% → 계수 1.25
- 수료율 87.5% → 계수 1.125
- 수료율 62.5% → 계수 0.875
- 수료율 25% → 계수 0.75

### 2. 과정별 매출 계산 (`computeCourseRevenue`)
```typescript
// 특정 연도 지정 시
if (year가 지정됨) {
    baseRevenue = 조정_YYYY년 ?? YYYY년 ?? 0
    
    // 이미 조정되지 않은 경우 수료율 보정 적용
    if (!이미_조정됨) {
        baseRevenue = baseRevenue × calculateRevenueAdjustmentFactor(수료율)
    }
    
    return baseRevenue
}

// 전체 연도 합산 시
baseRevenue = Σ(조정_2021년 + 조정_2022년 + ... + 조정_2026년)

if (baseRevenue === 0) {
    baseRevenue = 조정_실매출대비 ?? 실매출대비 ?? 누적매출
}

// 이미 조정되지 않은 경우 수료율 보정 적용
if (!이미_조정됨) {
    baseRevenue = baseRevenue × calculateRevenueAdjustmentFactor(수료율)
}

return baseRevenue
```

### 3. 최대 매출 모드 (`revenueMode: 'max'`)
```typescript
// 최대 매출 모드에서 연도별 매출 계산
if (revenueMode === 'max') {
    maxRevenue = 매출최대
    
    if (year가 지정됨) {
        yearRevenue = 조정_YYYY년 ?? YYYY년 ?? 0
        totalRevenueBase = Σ(조정_2021년 + ... + 조정_2026년)
        
        if (totalRevenueBase === 0) {
            totalRevenueBase = 조정_실매출대비 ?? 실매출대비 ?? 누적매출
        }
        
        return maxRevenue × (yearRevenue / totalRevenueBase)
    }
    
    return maxRevenue
}
```

### 4. 선도기업 과정 매출 분배
```typescript
// 선도기업 과정의 경우 매출 분배
if (선도기업_과정 && 파트너기관_존재) {
    if (훈련기관 === 파트너기관) {
        훈련기관_매출 = 100%  // 동일하면 훈련기관이 100% 흡수
    } else {
        파트너기관_매출 = 90%
        훈련기관_매출 = 10%
    }
} else {
    훈련기관_매출 = 100%  // 일반 과정
}
```

---

## 취업 관련 계산

### 1. 취업인원 선택 규칙 (`getPreferredEmploymentCount`)
```typescript
// 우선순위: 6개월 > 3개월 > 전체
if (취업인원(6개월) > 0) {
    return 취업인원(6개월)
} else if (취업인원(3개월) > 0) {
    return 취업인원(3개월)
} else {
    return 취업인원(전체)
}
```

### 2. 취업율 계산
```typescript
취업율(%) = (총 취업인원 / 총 수료인원) × 100

// 조건:
// - 수료인원 > 0인 경우만 계산
// - 취업인원은 getPreferredEmploymentCount로 선택된 값 사용
```

---

## 기관별 통계 계산

### 1. 기관 그룹화 (`groupInstitutionsAdvanced`)
```typescript
// 유사한 기관명을 하나의 그룹으로 묶음
// 예: "이젠", "이젠컴퓨터학원", "이젠아이티아카데미" → "이젠아카데미"
```

### 2. 기관별 상세 매출 계산 (`calculateInstitutionDetailedRevenue`)
```typescript
// 각 과정에 대해 기관별 매출 분배
totalRevenue = 0
coursesForInstitution = []

for (각 과정) {
    revenueShare = 매출_분배_비율  // 선도기업 과정 분배 규칙 적용
    
    if (revenueShare > 0) {
        courseRevenue = computeCourseRevenueByMode(과정, year, revenueMode) × revenueShare
        totalRevenue += courseRevenue
        coursesForInstitution.push(과정)
    }
}

return { courses: coursesForInstitution, totalRevenue }
```

### 3. 기관별 통계 (`calculateInstitutionStats`)
```typescript
// 각 기관에 대해 다음 통계 계산:

// 1. 총 매출
totalRevenue = Σ(각 과정의 분배된 매출)

// 2. 과정 수 (X(Y) 형식)
// X: 현재 연도에 시작한 과정 수
// Y: 과거 연도에 시작하여 현재 연도에 진행 중인 과정 수
totalCourses = "X(Y)"

// 3. 수강신청 인원 (X(Y) 형식)
// X: 현재 연도에 시작한 과정의 수강신청 인원 합
// Y: 과거 연도에 시작하여 현재 연도에 진행 중인 과정의 수강신청 인원 합
totalStudents = "X(Y)"

// 4. 수료인원 (X(Y) 형식)
// X: 현재 연도에 시작하여 현재 연도에 종료된 과정의 수료인원 합
// Y: 과거 연도에 시작하여 현재 연도에 종료된 과정의 수료인원 합
completedStudents = "X(Y)"

// 5. 취업인원
totalEmployed = Σ(getPreferredEmploymentCount(과정))

// 6. 수료율
// 조건: 수료인원 > 0, 수강신청 인원 > 0, 과정 종료일이 3주 이상 지난 과정만
수료율 = (유효 수료인원 합계 / 유효 수강신청 인원 합계) × 100

// 7. 취업율
취업율 = (총 취업인원 / 총 수료인원) × 100

// 8. 평균 만족도 (가중 평균)
평균만족도 = Σ(만족도 × 수료인원) / Σ(수료인원)
// 조건: 만족도 > 0, 수료인원 > 0
```

**선도기업 과정 처리:**
- 선도기업 과정의 경우 파트너기관이 학생수/수료인원/과정수 100% 담당
- 훈련기관은 학생수/수료인원/과정수 0
- 매출은 파트너기관 90%, 훈련기관 10% 분배

---

## 월별 통계 계산

### 1. 월별 통계 (`calculateMonthlyStatistics`)
```typescript
// 각 월별로 다음 통계 계산:

// 1. 매출
// - 과정이 해당 연도에 진행된 월 수 계산
// - 연도별 매출을 해당 월 수로 균등 분배
monthsInThisCourseYear = 과정이 해당 연도에 진행된 월 수
revenuePerMonth = 연도별_매출 / monthsInThisCourseYear

// 각 월에 revenuePerMonth 추가

// 2. 수강신청 인원
// - 과정 시작 월에만 추가
totalStudents = Σ(과정 시작 월의 수강신청 인원)

// 3. 수료인원
// - 과정 시작 월에만 추가
completedStudents = Σ(과정 시작 월의 수료인원)

// 4. 수료율
// - 해당 월에 시작한 과정들 중 유효한 과정만
// - 조건: 수료인원 > 0, 수강신청 인원 > 0
수료율 = (유효 과정의 수료인원 합계 / 유효 과정의 수강신청 인원 합계) × 100
```

**매출 분배 로직:**
```typescript
// 과정이 여러 연도에 걸쳐 진행되는 경우
for (각 연도) {
    if (해당 연도에 매출이 있음) {
        iterStartMonth = (연도 === 과정시작연도) ? 과정시작월 : 0
        iterEndMonth = (연도 === 과정종료연도) ? 과정종료월 : 11
        
        monthsInThisCourseYear = iterStartMonth부터 iterEndMonth까지의 월 수
        
        revenuePerMonth = 해당연도_매출 / monthsInThisCourseYear
        
        // 각 월에 revenuePerMonth 추가
    }
}
```

---

## 연도별 통계 계산

### 1. 연도별 통계 (`calculateYearlyStats`)
```typescript
// 특정 연도의 통계 계산:

// 1. 수강신청 인원
totalStudents = Σ(해당 연도 과정의 수강신청 인원)

// 2. 수료인원
completedStudents = Σ(해당 연도 과정의 수료인원)

// 3. 매출
revenue = Σ(해당 연도의 YYYY년 컬럼 값)
```

---

## 과정 집계 계산

### 1. 훈련과정 ID별 집계 (`aggregateCoursesByCourseIdWithLatestInfo`)
```typescript
// 같은 훈련과정 ID를 가진 과정들을 하나로 집계:

// 1. 총 누적 매출
총누적매출 = Σ(각 과정의 분배된 매출)

// 2. 총 수강신청 인원
총수강신청인원 = Σ(각 과정의 수강신청 인원 × studentShare)

// 3. 총 수료인원
총수료인원 = Σ(각 과정의 수료인원 × studentShare)

// 4. 총 취업인원
총취업인원 = Σ(getPreferredEmploymentCount(과정) × studentShare)

// 5. 원천 과정 수
원천과정수 = Σ(studentShare > 0 ? 1 : 0)

// 6. 평균 수료율
// 조건: 해당 연도에 종료된 과정, 수료인원 > 0, 수강신청 인원 > 0, 종료일이 3주 이상 지난 과정
평균수료율 = (유효 수료인원 합계 / 유효 수강신청 인원 합계) × 100

// 7. 평균 취업율
평균취업율 = (총 취업인원 / 총 수료인원) × 100

// 8. 평균 만족도
// 조건: 해당 연도에 종료된 과정, 만족도 > 0
평균만족도 = Σ(만족도 × studentShare) / Σ(studentShare > 0 ? 1 : 0)

// 9. 연도별 인원 표시 (X(Y) 형식)
// X: 현재 연도에 시작한 과정의 인원
// Y: 과거 연도에 시작하여 현재 연도에 진행 중인 과정의 인원
studentsStr = "X(Y)"
graduatesStr = "X(Y)"
openCountStr = "X(Y)"
```

**studentShare 규칙:**
```typescript
// 선도기업 과정:
if (파트너기관 === 현재기관) {
    studentShare = 1  // 파트너기관: 100%
} else if (훈련기관 === 현재기관) {
    studentShare = 0  // 훈련기관: 0% (학생 수는 0)
}

// 일반 과정:
if (훈련기관 === 현재기관) {
    studentShare = 1  // 훈련기관: 100%
}
```

### 2. 연도별 정원 및 훈련생 수
```typescript
// 모집률 계산용
// X: 현재 연도에 시작한 과정의 정원/훈련생 수
// Y: 과거 연도에 시작하여 현재 연도에 진행 중인 과정의 정원/훈련생 수

연도정원 = Σ(현재 연도 시작 과정의 정원 × studentShare)
과거년도정원 = Σ(과거 연도 시작 과정의 정원 × studentShare)
연도훈련생수 = Σ(현재 연도 시작 과정의 수강신청 인원 × studentShare)
```

---

## 만족도 계산

### 1. 기관별 평균 만족도
```typescript
// 가중 평균 사용 (수료인원을 가중치로 사용)
평균만족도 = Σ(만족도 × 수료인원) / Σ(수료인원)

// 조건:
// - 만족도 > 0
// - 수료인원 > 0
```

### 2. 과정별 평균 만족도
```typescript
// 단순 평균 사용
평균만족도 = Σ(만족도) / 과정 수

// 조건:
// - 만족도 > 0
// - 해당 연도에 종료된 과정만
```

---

## 특수 규칙 및 필터링

### 1. 과정 종료일 필터링
```typescript
// 수료율 계산 시 제외 조건
const threeWeeksAgo = 오늘 - 21일
if (과정종료일 > threeWeeksAgo) {
    // 수료율 계산에서 제외
}
```

### 2. 연도별 필터링
```typescript
// 특정 연도에 진행 중인 과정 필터링
if (year가 지정됨) {
    // 조건: 과정시작연도 === year OR (과정시작연도 < year AND 과정종료연도 >= year)
}
```

### 3. 선도기업 과정 판단
```typescript
// 파트너기관이 존재하면 선도기업 과정으로 간주
isLeadingCompanyCourse = (파트너기관 !== '' && 파트너기관 !== '0')
```

### 4. 훈련 유형 분류 (`classifyTrainingType`)
```typescript
// 과정명과 기관명을 기반으로 훈련 유형 분류
if (파트너기관 존재) {
    types.push('선도기업형 훈련')
}
if (과정명.includes('재직자_')) {
    types.push('재직자 훈련')
}
if (훈련기관.includes('학교')) {
    types.push('대학주도형 훈련')
}
if (과정명.includes('심화_')) {
    types.push('심화 훈련')
}
if (과정명.includes('융합')) {
    types.push('융합 훈련')
}

return types.length > 0 ? types.join('&') : '신기술 훈련'
```

---

## 데이터 변환 규칙

### 1. 훈련과정 ID별 최신 과정명 업데이트
```typescript
// 같은 훈련과정 ID를 가진 과정들 중
// 과정시작일이 가장 늦은 과정의 과정명을 모든 과정에 적용
최신과정명 = 훈련과정ID별_최신_과정명
```

### 2. 기관명 그룹화
```typescript
// 원본 기관명은 원본훈련기관 필드에 보존
// 표시용 기관명은 그룹화된 기관명 사용
```

---

## 주요 계산식 요약

### 수료율
```
수료율 = (수료인원 합계 / 수강신청 인원 합계) × 100
```

### 취업율
```
취업율 = (취업인원 합계 / 수료인원 합계) × 100
```

### 매출 조정
```
조정_매출 = 원본_매출 × calculateRevenueAdjustmentFactor(수료율)
```

### 평균 만족도
```
평균만족도 = Σ(만족도 × 수료인원) / Σ(수료인원)
```

### 월별 매출 분배
```
월별_매출 = 연도별_매출 / 해당_연도_진행_월수
```

---

## 참고사항

1. **X(Y) 표기법**: 현재 연도 값(X)와 과거 연도 값(Y)을 함께 표시
2. **선도기업 과정**: 파트너기관이 학생 수와 매출의 대부분을 담당
3. **3주 규칙**: 과정 종료일이 오늘 기준 21일 이내인 과정은 수료율 계산에서 제외
4. **매출 분배**: 선도기업 과정은 파트너기관 90%, 훈련기관 10%로 분배
5. **취업인원 우선순위**: 6개월 > 3개월 > 전체
